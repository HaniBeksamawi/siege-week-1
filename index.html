<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Flow Navigator Manager</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background: #f4f7fb;
    margin: 0;
    padding: 0;
    text-align: center;
  }
  h1 {
    margin: 20px 0;
    color: #333;
  }
  .card {
    display: none;
    background: white;
    padding: 20px;
    margin: 20px auto;
    max-width: 600px;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  }
  input, select {
    margin: 6px;
    padding: 10px;
    border: 1px solid #ccc;
    border-radius: 8px;
    outline: none;
    position: relative;
  }
  input:focus, select:focus {
    border-color: #3498db;
    box-shadow: 0 0 5px rgba(52,152,219,0.5);
  }
  
  /* Autocomplete Styles */
  .autocomplete-container {
    position: relative;
    display: inline-block;
  }
  .autocomplete-suggestions {
    position: absolute;
    background: white;
    border: 1px solid #ddd;
    border-radius: 8px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    max-height: 200px;
    overflow-y: auto;
    z-index: 1000;
    width: 100%;
    margin-top: 2px;
  }
  .autocomplete-suggestion {
    padding: 10px;
    cursor: pointer;
    border-bottom: 1px solid #eee;
  }
  .autocomplete-suggestion:hover {
    background: #f0f0f0;
  }
  .autocomplete-suggestion:last-child {
    border-bottom: none;
  }
  .btn {
    margin: 6px;
    padding: 10px 18px;
    border: none;
    border-radius: 8px;
    background: #3498db;
    color: white;
    font-weight: bold;
    cursor: pointer;
    box-shadow: 0 3px 8px rgba(0,0,0,0.15);
    transition: all 0.25s ease;
  }
  .btn:hover {
    background: #2980b9;
    transform: translateY(-2px);
    box-shadow: 0 5px 12px rgba(0,0,0,0.25);
  }
  .btn:active {
    transform: translateY(0);
    box-shadow: 0 2px 6px rgba(0,0,0,0.2);
  }
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
  }
  th, td {
    border: 1px solid #ddd;
    padding: 8px;
  }
  th {
    background: #3498db;
    color: white;
  }
  td {
    text-align: center;
  }
  .muted {
    color: gray;
    font-size: 14px;
  }
  #graphSection {
    margin-top: 20px;
  }

  /* Task Manager Styles */
  #taskManagerCard {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.1);
    z-index: 1000;
  }
  #taskManagerContent {
    position: absolute;
    top: 60px;
    left: 50%;
    transform: translateX(-50%);
    width: 80%;
    height: 75%;
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    padding: 20px;
    overflow: auto;
  }
  #taskManagerCard h2 {
    text-align: center;
    margin-top: 0;
  }
  #backTaskManagerBtn {
    position: absolute;
    top: 20px;
    left: 20px;
    background: #555;
  }

  /* Positioning Home Buttons */
  #openTracker {
    display: block;
    margin: 15px auto;
  }
  #openIncomeTracker {
    display: block;
    margin: 15px auto;
    background: #27ae60;
  }
  #taskManagerBtn {
    display: block;
    margin: 10px auto;
  }
  #logoutBtn {
    position: fixed;
    bottom: 110px;
    left: 20px;
  }
  #settingsBtn {
    position: fixed;
    bottom: 65px;
    left: 20px;
  }
  #historyBtn {
    position: fixed;
    bottom: 20px;
    left: 20px;
  }

  /* History Entry Styles */
  .history-entry {
    background: #f9f9f9;
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 12px;
    margin: 10px 0;
    text-align: left;
  }
  .history-timestamp {
    font-weight: bold;
    color: #3498db;
    font-size: 13px;
    margin-bottom: 5px;
  }
  .history-action {
    font-weight: bold;
    color: #333;
    margin-bottom: 8px;
  }
  .history-details {
    background: #fff;
    border-left: 3px solid #3498db;
    padding: 8px;
    margin-top: 5px;
    font-size: 12px;
  }
  .history-before {
    color: #e74c3c;
    margin: 3px 0;
  }
  .history-after {
    color: #27ae60;
    margin: 3px 0;
  }

  /* Income specific styles */
  .income-th {
    background: #27ae60 !important;
  }
  
</style>
</head>
<body>
<h1>Multi Manager Tool</h1>
<div id="datetime" style="position:absolute; top:10px; right:20px; font-size:14px; color:#555;"></div>

<!-- LOGIN CARD -->
<div id="loginCard" class="card" style="display:block;">
  <h2>Login</h2>
  <input type="text" id="loginUser" placeholder="Username"><br>
  <input type="password" id="loginPass" placeholder="Password"><br>
  <button id="loginBtn" class="btn">Login</button>
  <p class="muted">Don't have an account? <a href="#" id="toSignup">Sign up</a></p>
</div>

<!-- SIGNUP CARD -->
<div id="signupCard" class="card">
  <h2>Sign Up</h2>
  <input type="text" id="signupUser" placeholder="Choose Username"><br>
  <input type="password" id="signupPass" placeholder="Choose Password"><br>
  <button id="signupBtn" class="btn">Sign Up</button>
  <p class="muted">Already have an account? <a href="#" id="toLogin">Login</a></p>
</div>

<!-- HOME CARD -->
<div id="homeCard" class="card">
  <button id="openTracker" class="btn">Open Expense Tracker</button>
  <button id="openIncomeTracker" class="btn" style="background:#27ae60;">Open Income Tracker</button>
  <button id="taskManagerBtn" class="btn" style="background:#2ecc71;">Task Manager</button>
  <button id="logoutBtn" class="btn" style="background:#e74c3c;">Log out</button>
  <button id="settingsBtn" class="btn" style="background:#555;">Settings</button>
  <button id="historyBtn" class="btn" style="background:#555;">History</button>
</div>

<!-- TASK MANAGER CARD -->
<div id="taskManagerCard">
  <div id="taskManagerContent">
    <h2>Task Manager</h2>
    <button id="backTaskManagerBtn" class="btn">Back Home</button>
    <div style="width:100%; height:calc(100% - 60px); background:#fff; border:1px solid #ccc; border-radius:8px; margin-top:10px;"></div>
  </div>
</div>

<!-- TRACKER CARD (EXPENSES) -->
<div id="trackerCard" class="card">
  <h2>Expense Tracker</h2>
  <div>
    <input type="date" id="dateInput">
    <div class="autocomplete-container" style="display:inline-block;">
      <input type="text" id="categoryInput" placeholder="Category" autocomplete="off">
      <div id="categorySuggestions" class="autocomplete-suggestions" style="display:none;"></div>
    </div>
    <input type="text" id="nameInput" placeholder="Name">
    <input type="number" id="priceInput" placeholder="Amount">
    <button id="addExpenseBtn" class="btn">Add Expense</button>
  </div>
  <table>
    <thead>
      <tr>
        <th>Date</th>
        <th>Category</th>
        <th>Name</th>
        <th>Amount</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="expensesTbody"></tbody>
  </table>
  <button id="showGraphBtn" class="btn">Graph Analysis</button>
  <button id="backHomeBtn" class="btn" style="background:#555;">Back Home</button>
</div>

<!-- INCOME TRACKER CARD -->
<div id="incomeTrackerCard" class="card">
  <h2>Income Tracker</h2>
  <div>
    <input type="date" id="incomeDateInput">
    <div class="autocomplete-container" style="display:inline-block;">
      <input type="text" id="incomeCategoryInput" placeholder="Source" autocomplete="off">
      <div id="incomeSourceSuggestions" class="autocomplete-suggestions" style="display:none;"></div>
    </div>
    <input type="text" id="incomeNameInput" placeholder="Description">
    <input type="number" id="incomeAmountInput" placeholder="Amount">
    <button id="addIncomeBtn" class="btn" style="background:#27ae60;">Add Income</button>
  </div>
  <table>
    <thead>
      <tr>
        <th class="income-th">Date</th>
        <th class="income-th">Source</th>
        <th class="income-th">Description</th>
        <th class="income-th">Amount</th>
        <th class="income-th">Actions</th>
      </tr>
    </thead>
    <tbody id="incomesTbody"></tbody>
  </table>
  <button id="showIncomeGraphBtn" class="btn" style="background:#27ae60;">Graph Analysis</button>
  <button id="backHomeFromIncomeBtn" class="btn" style="background:#555;">Back Home</button>
</div>

<!-- HISTORY CARD -->
<div id="historyCard" class="card" style="display:none;">
    <h2 style="text-align:center;">History</h2>
    <button id="backHistoryBtn" class="btn" style="background:#555; position:absolute; top:20px; left:20px;">Back Home</button>
    <div id="historyLog" style="width:90%; max-width:900px; margin:60px auto; background:#fff; border:1px solid #ccc; border-radius:8px; padding:10px; text-align:left; font-size:12px; overflow-y:auto; height:70%;">
      <p class="muted">No actions recorded yet.</p>
    </div>
</div>

<!-- GRAPH SECTION (EXPENSES) -->
<div id="graphSection" class="card" style="display:none;">
  <h2>Expense Graph</h2>
  <label>From: <input type="date" id="fromDate"></label>
  <label>To: <input type="date" id="toDate"></label>
  <button id="applyFilterBtn" class="btn">Apply Filter</button>
  <canvas id="expenseChart" width="400" height="200"></canvas>
  <button id="backTrackerBtn" class="btn" style="background:#555;">Back</button>
</div>

<!-- INCOME GRAPH SECTION -->
<div id="incomeGraphSection" class="card" style="display:none;">
  <h2>Income Graph</h2>
  <label>From: <input type="date" id="incomeFromDate"></label>
  <label>To: <input type="date" id="incomeToDate"></label>
  <button id="applyIncomeFilterBtn" class="btn" style="background:#27ae60;">Apply Filter</button>
  <canvas id="incomeChart" width="400" height="200"></canvas>
  <button id="backIncomeTrackerBtn" class="btn" style="background:#555;">Back</button>
</div>

<!-- SETTINGS PAGE -->
<div id="settingsCard" class="card" style="display:none;">
  <h2>Settings</h2>
  <button id="deleteAllBtn" class="btn" style="background:#e67e22; display:block; width:80%; margin:10px auto;">Delete All Expenses</button>
  <button id="deleteAllIncomeBtn" class="btn" style="background:#e67e22; display:block; width:80%; margin:10px auto;">Delete All Income</button>
  <button id="deleteHistoryBtn" class="btn" style="background:#e67e22; display:block; width:80%; margin:10px auto;">Delete All History</button>
  <button id="deleteAccountBtn" class="btn" style="background:#e74c3c; display:block; width:80%; margin:10px auto;">Delete Account</button>
  <button id="backSettingsBtn" class="btn" style="background:#555; display:block; width:80%; margin:10px auto;">Back</button>
</div>

<!-- TABLE CARD -->
<div id="tableCard" class="card" style="display:none;">
  <h2>Full Expense Table</h2>
  <table>
    <thead>
      <tr>
        <th>Date</th>
        <th>Category</th>
        <th>Name</th>
        <th>Amount</th>
      </tr>
    </thead>
    <tbody id="fullTableTbody"></tbody>
  </table>
  <button id="backTableBtn" class="btn" style="background:#555;">Back</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
(function(){
  const loginCard=document.getElementById('loginCard'),
        signupCard=document.getElementById('signupCard'),
        homeCard=document.getElementById('homeCard'),
        trackerCard=document.getElementById('trackerCard'),
        incomeTrackerCard=document.getElementById('incomeTrackerCard'),
        graphSection=document.getElementById('graphSection'),
        incomeGraphSection=document.getElementById('incomeGraphSection'),
        settingsCard=document.getElementById('settingsCard'),
        tableCard=document.getElementById('tableCard'),
        loginBtn=document.getElementById('loginBtn'),
        signupBtn=document.getElementById('signupBtn'),
        toSignup=document.getElementById('toSignup'),
        toLogin=document.getElementById('toLogin'),
        openTracker=document.getElementById('openTracker'),
        openIncomeTracker=document.getElementById('openIncomeTracker'),
        logoutBtn=document.getElementById('logoutBtn'),
        settingsBtn=document.getElementById('settingsBtn'),
        backSettingsBtn=document.getElementById('backSettingsBtn'),
        backHomeBtn=document.getElementById('backHomeBtn'),
        backHomeFromIncomeBtn=document.getElementById('backHomeFromIncomeBtn'),
        backTrackerBtn=document.getElementById('backTrackerBtn'),
        backIncomeTrackerBtn=document.getElementById('backIncomeTrackerBtn'),
        showGraphBtn=document.getElementById('showGraphBtn'),
        showIncomeGraphBtn=document.getElementById('showIncomeGraphBtn'),
        addExpenseBtn=document.getElementById('addExpenseBtn'),
        addIncomeBtn=document.getElementById('addIncomeBtn'),
        deleteAllBtn=document.getElementById('deleteAllBtn'),
        deleteAllIncomeBtn=document.getElementById('deleteAllIncomeBtn'),
        deleteHistoryBtn=document.getElementById('deleteHistoryBtn'),
        deleteAccountBtn=document.getElementById('deleteAccountBtn'),
        expensesTbody=document.getElementById('expensesTbody'),
        incomesTbody=document.getElementById('incomesTbody'),
        dateInput=document.getElementById('dateInput'),
        categoryInput=document.getElementById('categoryInput'),
        categorySuggestions=document.getElementById('categorySuggestions'),
        nameInput=document.getElementById('nameInput'),
        priceInput=document.getElementById('priceInput'),
        incomeDateInput=document.getElementById('incomeDateInput'),
        incomeCategoryInput=document.getElementById('incomeCategoryInput'),
        incomeSourceSuggestions=document.getElementById('incomeSourceSuggestions'),
        incomeNameInput=document.getElementById('incomeNameInput'),
        incomeAmountInput=document.getElementById('incomeAmountInput'),
        fromDate=document.getElementById('fromDate'),
        toDate=document.getElementById('toDate'),
        incomeFromDate=document.getElementById('incomeFromDate'),
        incomeToDate=document.getElementById('incomeToDate'),
        applyFilterBtn=document.getElementById('applyFilterBtn'),
        applyIncomeFilterBtn=document.getElementById('applyIncomeFilterBtn'),
        expenseChart=document.getElementById('expenseChart'),
        incomeChart=document.getElementById('incomeChart'),
        fullTableTbody=document.getElementById('fullTableTbody'),
        backTableBtn=document.getElementById('backTableBtn'),
        taskManagerBtn=document.getElementById('taskManagerBtn'),
        taskManagerCard=document.getElementById('taskManagerCard'),
        backTaskManagerBtn=document.getElementById('backTaskManagerBtn'),
        historyBtn = document.getElementById('historyBtn'),
        historyCard = document.getElementById('historyCard'),
        backHistoryBtn = document.getElementById('backHistoryBtn'),
        historyLog = document.getElementById('historyLog');

  let currentUser=null, chart=null, incomeChartObj=null, editingIndex=null, editingIncomeIndex=null;

  function userKey(u){return 'user_'+u;}
  function getUserData(u){return JSON.parse(localStorage.getItem(userKey(u))); }
  function setUserData(u,d){localStorage.setItem(userKey(u),JSON.stringify(d)); }
  function escapeHtml(t){return t.replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;' }[m])); }

  // --- HISTORY FUNCTIONS ---
  function addHistoryEntry(action, details){
    if(!currentUser) return;
    let data=getUserData(currentUser);
    if(!data) data = {password:'', expenses:[], incomes:[], history:[]};
    if(!data.history) data.history=[];
    const timestamp=new Date().toLocaleString();
    data.history.push({timestamp, action, details});
    setUserData(currentUser,data);
  }

  function renderHistory(){
    if(!currentUser) return;
    const data=getUserData(currentUser);
    if(!data || !data.history || data.history.length===0){
      historyLog.innerHTML='<p class="muted">No actions recorded yet.</p>';
    } else {
      // show newest first
      const reversed = data.history.slice().reverse();
      historyLog.innerHTML = reversed.map(h=>{
        let html = `<div class="history-entry">`;
        html += `<div class="history-timestamp">${escapeHtml(h.timestamp || h)}</div>`;
        
        if(typeof h === 'string'){
          // Old format compatibility
          html += `<div class="history-action">${escapeHtml(h)}</div>`;
        } else {
          html += `<div class="history-action">${escapeHtml(h.action)}</div>`;
          if(h.details){
            html += `<div class="history-details">`;
            if(h.details.before){
              html += `<div class="history-before"><strong>Before:</strong> Date: ${escapeHtml(h.details.before.date)}, Category: ${escapeHtml(h.details.before.category)}, Name: ${escapeHtml(h.details.before.name)}, Amount: $${h.details.before.price.toFixed(2)}</div>`;
            }
            if(h.details.after){
              html += `<div class="history-after"><strong>After:</strong> Date: ${escapeHtml(h.details.after.date)}, Category: ${escapeHtml(h.details.after.category)}, Name: ${escapeHtml(h.details.after.name)}, Amount: $${h.details.after.price.toFixed(2)}</div>`;
            }
            if(h.details.deleted){
              html += `<div class="history-before"><strong>Deleted:</strong> Date: ${escapeHtml(h.details.deleted.date)}, Category: ${escapeHtml(h.details.deleted.category)}, Name: ${escapeHtml(h.details.deleted.name)}, Amount: $${h.details.deleted.price.toFixed(2)}</div>`;
            }
            if(h.details.added){
              html += `<div class="history-after"><strong>Added:</strong> Date: ${escapeHtml(h.details.added.date)}, Category: ${escapeHtml(h.details.added.category)}, Name: ${escapeHtml(h.details.added.name)}, Amount: $${h.details.added.price.toFixed(2)}</div>`;
            }
            html += `</div>`;
          }
        }
        html += `</div>`;
        return html;
      }).join('');
    }
  }

  toSignup.onclick=()=>{loginCard.style.display='none'; signupCard.style.display='block';};
  toLogin.onclick=()=>{signupCard.style.display='none'; loginCard.style.display='block';};

  signupBtn.onclick=()=>{
    const u=document.getElementById('signupUser').value.trim(), p=document.getElementById('signupPass').value;
    if(!u||!p)return alert('Fill in both fields');
    if(localStorage.getItem(userKey(u)))return alert('Username already exists');
    setUserData(u,{password:p,expenses:[],incomes:[],history:[]}); alert('Account created!'); signupCard.style.display='none'; loginCard.style.display='block';
  };

  loginBtn.onclick=()=>{
    const u=document.getElementById('loginUser').value.trim(), p=document.getElementById('loginPass').value;
    const data=getUserData(u);
    if(!data||data.password!==p)return alert('Invalid credentials');
    currentUser=u; loginCard.style.display='none'; homeCard.style.display='block';
    renderHistory();
  };

  logoutBtn.onclick=()=>{currentUser=null; homeCard.style.display='none'; loginCard.style.display='block';};

  openTracker.onclick=()=>{homeCard.style.display='none'; trackerCard.style.display='block'; renderExpenses();};
  backHomeBtn.onclick=()=>{trackerCard.style.display='none'; homeCard.style.display='block'; renderHistory();};

  openIncomeTracker.onclick=()=>{homeCard.style.display='none'; incomeTrackerCard.style.display='block'; renderIncomes();};
  backHomeFromIncomeBtn.onclick=()=>{incomeTrackerCard.style.display='none'; homeCard.style.display='block'; renderHistory();};

  settingsBtn.onclick=()=>{homeCard.style.display='none'; settingsCard.style.display='block';};
  backSettingsBtn.onclick=()=>{settingsCard.style.display='none'; homeCard.style.display='block'; renderHistory();};

  showGraphBtn.onclick=()=>{trackerCard.style.display='none'; graphSection.style.display='block'; updateGraph();};
  backTrackerBtn.onclick=()=>{graphSection.style.display='none'; trackerCard.style.display='block';};

  showIncomeGraphBtn.onclick=()=>{incomeTrackerCard.style.display='none'; incomeGraphSection.style.display='block'; updateIncomeGraph();};
  backIncomeTrackerBtn.onclick=()=>{incomeGraphSection.style.display='none'; incomeTrackerCard.style.display='block';};

  backTableBtn.onclick=()=>{tableCard.style.display='none'; homeCard.style.display='block'; renderHistory();};

  taskManagerBtn.onclick=()=>{homeCard.style.display='none'; taskManagerCard.style.display='block';};
  backTaskManagerBtn.onclick=()=>{taskManagerCard.style.display='none'; homeCard.style.display='block'; renderHistory();};

  // AUTOCOMPLETE FUNCTIONS FOR EXPENSE CATEGORIES
  function getUniqueCategories(){
    if(!currentUser) return [];
    const data=getUserData(currentUser);
    if(!data || !data.expenses) return [];
    const categories = data.expenses.map(e=>e.category);
    return [...new Set(categories)].sort();
  }

  function showCategorySuggestions(value){
    const categories = getUniqueCategories();
    const filtered = value ? categories.filter(c=>c.toLowerCase().startsWith(value.toLowerCase())) : categories;
    
    if(filtered.length === 0){
      categorySuggestions.style.display='none';
      return;
    }
    
    categorySuggestions.innerHTML = filtered.map(cat=>
      `<div class="autocomplete-suggestion" onclick="selectCategory('${escapeHtml(cat)}')">${escapeHtml(cat)}</div>`
    ).join('');
    categorySuggestions.style.display='block';
  }

  window.selectCategory = function(cat){
    categoryInput.value = cat;
    categorySuggestions.style.display='none';
  };

  categoryInput.addEventListener('focus', ()=>{
    showCategorySuggestions(categoryInput.value);
  });

  categoryInput.addEventListener('input', ()=>{
    showCategorySuggestions(categoryInput.value);
  });

  categoryInput.addEventListener('blur', ()=>{
    setTimeout(()=>categorySuggestions.style.display='none', 200);
  });

  // AUTOCOMPLETE FUNCTIONS FOR INCOME SOURCES
  function getUniqueSources(){
    if(!currentUser) return [];
    const data=getUserData(currentUser);
    if(!data || !data.incomes) return [];
    const sources = data.incomes.map(e=>e.category);
    return [...new Set(sources)].sort();
  }

  function showSourceSuggestions(value){
    const sources = getUniqueSources();
    const filtered = value ? sources.filter(c=>c.toLowerCase().startsWith(value.toLowerCase())) : sources;
    
    if(filtered.length === 0){
      incomeSourceSuggestions.style.display='none';
      return;
    }
    
    incomeSourceSuggestions.innerHTML = filtered.map(src=>
      `<div class="autocomplete-suggestion" onclick="selectSource('${escapeHtml(src)}')">${escapeHtml(src)}</div>`
    ).join('');
    incomeSourceSuggestions.style.display='block';
  }

  window.selectSource = function(src){
    incomeCategoryInput.value = src;
    incomeSourceSuggestions.style.display='none';
  };

  incomeCategoryInput.addEventListener('focus', ()=>{
    showSourceSuggestions(incomeCategoryInput.value);
  });

  incomeCategoryInput.addEventListener('input', ()=>{
    showSourceSuggestions(incomeCategoryInput.value);
  });

  incomeCategoryInput.addEventListener('blur', ()=>{
    setTimeout(()=>incomeSourceSuggestions.style.display='none', 200);
  });

  // EXPENSE FUNCTIONS
  addExpenseBtn.onclick=()=>{
    if(!currentUser)return;
    const d=dateInput.value, cat=categoryInput.value.trim(), name=nameInput.value.trim(), price=parseFloat(priceInput.value);
    if(!d||!cat||!name||isNaN(price))return alert('Fill all fields correctly');
    let data=getUserData(currentUser);
    if(!data.history) data.history = [];
    if(editingIndex!==null){
      const exp=data.expenses.find(exp=>exp.id==editingIndex);
      const before = {date: exp.date, category: exp.category, name: exp.name, price: exp.price};
      exp.date=d; exp.category=cat; exp.name=name; exp.price=price;
      const after = {date: d, category: cat, name: name, price: price};
      const timestamp=new Date().toLocaleString();
      data.history.push({timestamp, action: 'Edited Expense', details: {before, after}});
      editingIndex=null; addExpenseBtn.textContent='Add Expense';
    }else{
      const id=Date.now()+Math.random();
      data.expenses.push({id,date:d,category:cat,name:name,price:price});
      const added = {date: d, category: cat, name: name, price: price};
      const timestamp=new Date().toLocaleString();
      data.history.push({timestamp, action: 'Added Expense', details: {added}});
    }
    setUserData(currentUser,data); renderExpenses(); updateGraph();
    dateInput.value=''; categoryInput.value=''; nameInput.value=''; priceInput.value='';
  };

  window.editExpense=function(id){
    if(editingIndex!==null) return alert('Finish current update first!');
    const data=getUserData(currentUser); if(!data) return;
    const e=data.expenses.find(exp=>exp.id==id); if(!e)return;
    dateInput.value=e.date; categoryInput.value=e.category; nameInput.value=e.name; priceInput.value=e.price;
    editingIndex=id; addExpenseBtn.textContent='Update Expense';
  };

  window.deleteExpense=function(id){
    if(editingIndex!==null) return alert('Finish current update first!');
    let data=getUserData(currentUser); if(!data) return;
    if(!data.history) data.history = [];
    const e=data.expenses.find(exp=>exp.id==id);
    if(confirm('Delete this expense?')){
      data.expenses=data.expenses.filter(exp=>exp.id!=id);
      const deleted = {date: e.date, category: e.category, name: e.name, price: e.price};
      const timestamp=new Date().toLocaleString();
      data.history.push({timestamp, action: 'Deleted Expense', details: {deleted}});
      setUserData(currentUser,data); renderExpenses();
    }
  };

  deleteAllBtn.onclick=()=>{
    if(!currentUser)return;
    if(confirm('Delete ALL expenses?')){
      let data=getUserData(currentUser);
      if(!data.history) data.history = [];
      data.expenses=[];
      const timestamp=new Date().toLocaleString();
      data.history.push({timestamp, action: 'Deleted All Expenses', details: null});
      setUserData(currentUser,data); editingIndex=null; addExpenseBtn.textContent='Add Expense'; renderExpenses();
    }
  };

  // INCOME FUNCTIONS
  addIncomeBtn.onclick=()=>{
    if(!currentUser)return;
    const d=incomeDateInput.value, cat=incomeCategoryInput.value.trim(), name=incomeNameInput.value.trim(), amount=parseFloat(incomeAmountInput.value);
    if(!d||!cat||!name||isNaN(amount))return alert('Fill all fields correctly');
    let data=getUserData(currentUser);
    if(!data.incomes) data.incomes = [];
    if(!data.history) data.history = [];
    if(editingIncomeIndex!==null){
      const inc=data.incomes.find(inc=>inc.id==editingIncomeIndex);
      const before = {date: inc.date, category: inc.category, name: inc.name, price: inc.amount};
      inc.date=d; inc.category=cat; inc.name=name; inc.amount=amount;
      const after = {date: d, category: cat, name: name, price: amount};
      const timestamp=new Date().toLocaleString();
      data.history.push({timestamp, action: 'Edited Income', details: {before, after}});
      editingIncomeIndex=null; addIncomeBtn.textContent='Add Income';
    }else{
      const id=Date.now()+Math.random();
      data.incomes.push({id,date:d,category:cat,name:name,amount:amount});
      const added = {date: d, category: cat, name: name, price: amount};
      const timestamp=new Date().toLocaleString();
      data.history.push({timestamp, action: 'Added Income', details: {added}});
    }
    setUserData(currentUser,data); renderIncomes(); updateIncomeGraph();
    incomeDateInput.value=''; incomeCategoryInput.value=''; incomeNameInput.value=''; incomeAmountInput.value='';
  };

  window.editIncome=function(id){
    if(editingIncomeIndex!==null) return alert('Finish current update first!');
    const data=getUserData(currentUser); if(!data) return;
    const e=data.incomes.find(inc=>inc.id==id); if(!e)return;
    incomeDateInput.value=e.date; incomeCategoryInput.value=e.category; incomeNameInput.value=e.name; incomeAmountInput.value=e.amount;
    editingIncomeIndex=id; addIncomeBtn.textContent='Update Income';
  };

  window.deleteIncome=function(id){
    if(editingIncomeIndex!==null) return alert('Finish current update first!');
    let data=getUserData(currentUser); if(!data) return;
    if(!data.history) data.history = [];
    const e=data.incomes.find(inc=>inc.id==id);
    if(confirm('Delete this income?')){
      data.incomes=data.incomes.filter(inc=>inc.id!=id);
      const deleted = {date: e.date, category: e.category, name: e.name, price: e.amount};
      const timestamp=new Date().toLocaleString();
      data.history.push({timestamp, action: 'Deleted Income', details: {deleted}});
      setUserData(currentUser,data); renderIncomes();
    }
  };

  deleteAllIncomeBtn.onclick=()=>{
    if(!currentUser)return;
    if(confirm('Delete ALL income?')){
      let data=getUserData(currentUser);
      if(!data.history) data.history = [];
      data.incomes=[];
      const timestamp=new Date().toLocaleString();
      data.history.push({timestamp, action: 'Deleted All Income', details: null});
      setUserData(currentUser,data); editingIncomeIndex=null; addIncomeBtn.textContent='Add Income'; renderIncomes();
    }
  };

  deleteHistoryBtn.onclick=()=>{
    if(!currentUser)return;
    if(confirm('Delete ALL history?')){
      let data=getUserData(currentUser);
      data.history=[];
      setUserData(currentUser,data);
      alert('All history deleted!');
      renderHistory();
    }
  };

  deleteAccountBtn.onclick=()=>{
    if(!currentUser)return;
    if(confirm('DELETE ACCOUNT?')){
      localStorage.removeItem(userKey(currentUser));
      currentUser=null; editingIndex=null; editingIncomeIndex=null; addExpenseBtn.textContent='Add Expense'; addIncomeBtn.textContent='Add Income'; chart&&(chart.destroy(),chart=null); incomeChartObj&&(incomeChartObj.destroy(),incomeChartObj=null);
      loginCard.style.display='block'; homeCard.style.display='none'; trackerCard.style.display='none'; incomeTrackerCard.style.display='none'; settingsCard.style.display='none'; graphSection.style.display='none'; incomeGraphSection.style.display='none'; tableCard.style.display='none'; taskManagerCard.style.display='none';
    }
  };

  function renderExpenses(){
    if(!currentUser)return;
    const data=getUserData(currentUser)||{expenses:[]};
    const sorted=data.expenses.sort((a,b)=>new Date(a.date)-new Date(b.date));
    expensesTbody.innerHTML=sorted.map(e=>`<tr>
      <td>${escapeHtml(e.date)}</td>
      <td>${escapeHtml(e.category)}</td>
      <td>${escapeHtml(e.name)}</td>
      <td style="text-align:right">${e.price.toFixed(2)}</td>
      <td>
        <button class="btn" style="background:#f1c40f;color:#111;padding:6px 10px" onclick="editExpense('${e.id}')" ${editingIndex!==null?'disabled':''}>Edit</button>
        <button class="btn" style="background:#e74c3c;padding:6px 10px" onclick="deleteExpense('${e.id}')" ${editingIndex!==null?'disabled':''}>Delete</button>
      </td>
    </tr>`).join('');
    if(sorted.length===0)expensesTbody.innerHTML=`<tr><td colspan="5" class="muted">No expenses yet</td></tr>`;
    updateGraph();
  }

  function renderIncomes(){
    if(!currentUser)return;
    const data=getUserData(currentUser)||{incomes:[]};
    if(!data.incomes) data.incomes = [];
    const sorted=data.incomes.sort((a,b)=>new Date(a.date)-new Date(b.date));
    incomesTbody.innerHTML=sorted.map(e=>`<tr>
      <td>${escapeHtml(e.date)}</td>
      <td>${escapeHtml(e.category)}</td>
      <td>${escapeHtml(e.name)}</td>
      <td style="text-align:right">${e.amount.toFixed(2)}</td>
      <td>
        <button class="btn" style="background:#f1c40f;color:#111;padding:6px 10px" onclick="editIncome('${e.id}')" ${editingIncomeIndex!==null?'disabled':''}>Edit</button>
        <button class="btn" style="background:#e74c3c;padding:6px 10px" onclick="deleteIncome('${e.id}')" ${editingIncomeIndex!==null?'disabled':''}>Delete</button>
      </td>
    </tr>`).join('');
    if(sorted.length===0)incomesTbody.innerHTML=`<tr><td colspan="5" class="muted">No income yet</td></tr>`;
    updateIncomeGraph();
  }

  function updateGraph(filtered){
    if(!currentUser)return;
    const data=getUserData(currentUser); if(!data)return;
    let list=data.expenses.map(e=>({date:e.date,price:e.price}));
    if(filtered)list=filtered;
    chart&&chart.destroy();
    chart=new Chart(expenseChart.getContext('2d'),{type:'line',data:{labels:list.map(e=>e.date),datasets:[{label:'Expense ($)',data:list.map(e=>e.price),fill:false,borderColor:'#3498db',tension:0.1}]},options:{responsive:true,plugins:{legend:{display:true}}}});
  }

  function updateIncomeGraph(filtered){
    if(!currentUser)return;
    const data=getUserData(currentUser); if(!data)return;
    if(!data.incomes) data.incomes = [];
    let list=data.incomes.map(e=>({date:e.date,amount:e.amount}));
    if(filtered)list=filtered;
    incomeChartObj&&incomeChartObj.destroy();
    incomeChartObj=new Chart(incomeChart.getContext('2d'),{type:'line',data:{labels:list.map(e=>e.date),datasets:[{label:'Income ($)',data:list.map(e=>e.amount),fill:false,borderColor:'#27ae60',tension:0.1}]},options:{responsive:true,plugins:{legend:{display:true}}}});
  }

  applyFilterBtn.onclick=()=>{
    if(!currentUser)return;
    const from=fromDate.value?new Date(fromDate.value):null;
    const to=toDate.value?new Date(toDate.value):null;
    const data=getUserData(currentUser); if(!data)return;
    const filtered=data.expenses.filter(e=>{
      const d=new Date(e.date); if(from && d<from) return false; if(to && d>to) return false; return true;
    });
    updateGraph(filtered);
  };

  applyIncomeFilterBtn.onclick=()=>{
    if(!currentUser)return;
    const from=incomeFromDate.value?new Date(incomeFromDate.value):null;
    const to=incomeToDate.value?new Date(incomeToDate.value):null;
    const data=getUserData(currentUser); if(!data)return;
    if(!data.incomes) data.incomes = [];
    const filtered=data.incomes.filter(e=>{
      const d=new Date(e.date); if(from && d<from) return false; if(to && d>to) return false; return true;
    });
    updateIncomeGraph(filtered);
  };

  function renderFullTable(){
    if(!currentUser)return;
    const data=getUserData(currentUser)||{expenses:[]};
    const sorted=data.expenses.sort((a,b)=>new Date(a.date)-new Date(b.date));
    fullTableTbody.innerHTML=sorted.map(e=>`
      <tr>
        <td>${escapeHtml(e.date)}</td>
        <td>${escapeHtml(e.category)}</td>
        <td>${escapeHtml(e.name)}</td>
        <td style="text-align:right">${e.price.toFixed(2)}</td>
      </tr>
    `).join('');
    if(sorted.length===0)fullTableTbody.innerHTML=`<tr><td colspan="4" class="muted">No expenses yet</td></tr>`;
  }

  // --- HISTORY NAVIGATION ---
  historyBtn.onclick = () => { homeCard.style.display='none'; historyCard.style.display='block'; renderHistory(); };
  backHistoryBtn.onclick = () => { historyCard.style.display='none'; homeCard.style.display='block'; renderHistory(); };

})();
function updateDateTime() {
  const now = new Date();
  const options = { 
    weekday: 'short', year: 'numeric', month: 'short', 
    day: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit' 
  };
  document.getElementById('datetime').textContent = now.toLocaleString('en-US', options);
}
setInterval(updateDateTime, 1000);
updateDateTime(); // run once at start
</script>
</body>
</html>